<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Details - CareerLens</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* ... Keep all your existing styles ... */
        
        /* Loading Modal Styles */
        .loading-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(4px);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
        
        .loading-modal.active {
            display: flex;
        }
        
        .loading-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 3rem 2rem;
            max-width: 450px;
            width: 90%;
            text-align: center;
        }
        
        .loading-spinner {
            font-size: 4rem;
            color: var(--accent);
            margin-bottom: 1.5rem;
            animation: spin 2s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }
        
        .loading-message {
            color: var(--text-secondary);
            margin-bottom: 2rem;
            font-size: 1rem;
        }
        
        .progress-bar-container {
            width: 100%;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 1rem;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #5558d9);
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            color: var(--text-muted);
            font-size: 0.9rem;
        }
        
        .loading-steps {
            margin-top: 2rem;
            text-align: left;
        }
        
        .loading-step {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .loading-step.active {
            background: rgba(99, 102, 241, 0.2);
            border-left: 3px solid var(--accent);
        }
        
        .loading-step.complete {
            background: rgba(16, 185, 129, 0.2);
            border-left: 3px solid var(--success);
        }
        
        .step-icon {
            font-size: 1.2rem;
            color: var(--text-muted);
        }
        
        .loading-step.active .step-icon {
            color: var(--accent);
        }
        
        .loading-step.complete .step-icon {
            color: var(--success);
        }
        
        .step-text {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <!-- Your existing navbar -->
    <nav class="navbar">
        <div class="navbar-content">
            <div class="logo"><i class="fas fa-graduation-cap"></i> CareerLens</div>
            <span style="color: var(--text-secondary);">{{ session.user }}</span>
        </div>
    </nav>

    <div class="container">
        <a href="/dashboard" class="btn-back">
             Back to Dashboard
        </a>

        <!-- Your existing quiz info card -->
        <div class="quiz-info">
            <div class="quiz-info-header">
                <h1>{{ topic }}{% if subtopic %} - {{ subtopic }}{% endif %}</h1>
                <p>Adaptive AI-Generated Quiz</p>
            </div>

            <div class="quiz-info-details">
                <div class="info-row">
                    <span class="info-label"><i class="fas fa-list"></i> Questions</span>
                    <span class="info-value">20 Questions</span>
                </div>
                <div class="info-row">
                    <span class="info-label"><i class="fas fa-clock"></i> Time Limit</span>
                    <span class="info-value">30 Minutes</span>
                </div>
                <div class="info-row">
                    <span class="info-label"><i class="fas fa-signal"></i> Difficulty</span>
                    <span class="info-value">
                        <span class="badge">{{ difficulty or 'Medium' }}</span>
                    </span>
                </div>
            </div>

            {% if has_saved_progress %}
            <div class="saved-progress-alert">
                <p><i class="fas fa-info-circle"></i> <strong>You have a saved quiz in progress</strong></p>
                <p class="text-muted">Question {{ saved_question }}/20 â€¢ {{ saved_time_left }} remaining</p>
            </div>
            {% endif %}

            <div class="action-buttons">
                {% if has_saved_progress %}
                <form action="{{ url_for('quiz', topic=topic, subtopic=subtopic or '') }}" method="GET" style="margin: 0;">
                    <input type="hidden" name="resume" value="true">
                    <button type="submit" class="btn">
                        <i class="fas fa-play"></i> Resume Quiz
                    </button>
                </form>
                <button onclick="startQuiz(true)" class="btn btn-outline">
                    <i class="fas fa-redo"></i> Start Fresh
                </button>
                {% else %}
                <button onclick="startQuiz()" class="btn">
                    <i class="fas fa-play"></i> Start Quiz
                </button>
                {% endif %}
            </div>

            <div class="instructions">
                <h3>Instructions:</h3>
                <ul>
                    <li>Answer all questions before submitting</li>
                    <li>You can save and resume the quiz anytime</li>
                    <li>Timer will pause when you save progress</li>
                    <li>Each question has 4 options with one correct answer</li>
                    <li>Your score will be calculated instantly after submission</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="loading-modal" id="loadingModal">
        <div class="loading-content">
            <div class="loading-spinner">
                <i class="fas fa-robot"></i>
            </div>
            <div class="loading-title">Generating Questions...</div>
            <div class="loading-message" id="loadingMessage">
                AI is crafting personalized questions for you
            </div>
            
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="progress-text">
                <span id="progressPercent">0</span>% Complete
            </div>
            
            <div class="loading-steps">
                <div class="loading-step" id="step1">
                    <div class="step-icon"><i class="fas fa-circle-notch"></i></div>
                    <div class="step-text">Analyzing your performance...</div>
                </div>
                <div class="loading-step" id="step2">
                    <div class="step-icon"><i class="fas fa-circle-notch"></i></div>
                    <div class="step-text">Selecting difficulty level...</div>
                </div>
                <div class="loading-step" id="step3">
                    <div class="step-icon"><i class="fas fa-circle-notch"></i></div>
                    <div class="step-text">Generating unique questions...</div>
                </div>
                <div class="loading-step" id="step4">
                    <div class="step-icon"><i class="fas fa-circle-notch"></i></div>
                    <div class="step-text">Validating answers...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const topic = "{{ topic }}";
        const subtopic = "{{ subtopic or '' }}";
        let pollingInterval = null;
        
        function startQuiz(restart = false) {
            // Show loading modal
            document.getElementById('loadingModal').classList.add('active');
            
            // Start async generation
            fetch('/api/generate_questions_async', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    topic: topic,
                    subtopic: subtopic,
                    num_questions: 20,
                    restart: restart
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.task_id) {
                    // Start polling for progress
                    pollProgress(data.task_id);
                } else {
                    throw new Error('Failed to start generation');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('loadingModal').classList.remove('active');
                alert('Failed to start quiz generation. Please try again.');
            });
        }
        
        function pollProgress(taskId) {
            let lastProgress = 0;
            
            pollingInterval = setInterval(() => {
                fetch(`/api/check_progress/${taskId}`)
                    .then(response => response.json())
                    .then(data => {
                        const progress = data.progress || 0;
                        const message = data.message || 'Generating...';
                        
                        // Update progress bar
                        document.getElementById('progressBar').style.width = progress + '%';
                        document.getElementById('progressPercent').textContent = progress;
                        document.getElementById('loadingMessage').textContent = message;
                        
                        // Update steps based on progress
                        if (progress >= 10) {
                            updateStep('step1', progress >= 25 ? 'complete' : 'active');
                        }
                        if (progress >= 25) {
                            updateStep('step2', progress >= 50 ? 'complete' : 'active');
                        }
                        if (progress >= 50) {
                            updateStep('step3', progress >= 85 ? 'complete' : 'active');
                        }
                        if (progress >= 85) {
                            updateStep('step4', progress >= 100 ? 'complete' : 'active');
                        }
                        
                        // Check if complete
                        if (data.status === 'complete') {
                            clearInterval(pollingInterval);
                            
                            // Update all steps to complete
                            updateStep('step1', 'complete');
                            updateStep('step2', 'complete');
                            updateStep('step3', 'complete');
                            updateStep('step4', 'complete');
                            
                            // Redirect to quiz
                            setTimeout(() => {
                                const redirectUrl = `/quiz/${encodeURIComponent(topic)}${subtopic ? '/' + encodeURIComponent(subtopic) : ''}?task_id=${taskId}`;
                                window.location.href = redirectUrl;
                            }, 500);
                        }
                        else if (data.status === 'error') {
                            clearInterval(pollingInterval);
                            document.getElementById('loadingModal').classList.remove('active');
                            alert('Error generating questions: ' + (data.error || 'Unknown error'));
                        }
                        
                        lastProgress = progress;
                    })
                    .catch(error => {
                        console.error('Polling error:', error);
                        clearInterval(pollingInterval);
                        document.getElementById('loadingModal').classList.remove('active');
                        alert('Lost connection. Please try again.');
                    });
            }, 1000); // Poll every second
        }
        
        function updateStep(stepId, status) {
            const step = document.getElementById(stepId);
            step.classList.remove('active', 'complete');
            if (status) {
                step.classList.add(status);
            }
            
            if (status === 'complete') {
                step.querySelector('.step-icon i').className = 'fas fa-check-circle';
            } else if (status === 'active') {
                step.querySelector('.step-icon i').className = 'fas fa-spinner fa-spin';
            }
        }
    </script>
</body>
</html>